ARG ROS_DISTRO="jazzy"
FROM mc3ed/ecat_ros2_workshop:${ROS_DISTRO}

RUN apt update && DEBIAN_FRONTEND=noninteractive apt install -qqy \
    dbus-x11 \
    mesa-utils \
    net-tools \
    novnc \
    onboard \
    tigervnc-standalone-server \
    tigervnc-xorg-extension \
    x11-apps \
    xfce4 \
    curl \
    dirmngr \
    software-properties-common \
    apt-transport-https \
    gnupg \
    wget \
    ca-certificates \
    && mkdir ~/.vnc \
    && echo "#!/bin/sh\nstartxfce4" > ~/.vnc/xstartup \
    && chmod +x ~/.vnc/xstartup
  # Install VSCodium (Open Source build of VSCode)
RUN wget -q https://github.com/VSCodium/vscodium/releases/download/1.105.17075/codium_1.105.17075_amd64.deb && \
    apt update && \
    apt install -y ./codium_1.105.17075_amd64.deb && \
    rm codium_1.105.17075_amd64.deb && \
    # Create 'code' alias for codium with options
    echo "alias code='codium --no-sandbox --user-data-dir=/root/.config/codium'" >> /etc/bash.bashrc && \
    sed -i 's|^Exec=/usr/share/codium/codium .*|Exec=codium --no-sandbox --user-data-dir=/root/.config/codium %F|' /usr/share/applications/codium.desktop && \
    # Install Google Chrome (instead of Chromium)
    wget -q https://dl.google.com/linux/direct/google-chrome-stable_current_amd64.deb && \
    apt install -y ./google-chrome-stable_current_amd64.deb && \
    rm google-chrome-stable_current_amd64.deb && \
    # Create 'chrome' alias for google-chrome with options
    echo "alias chrome='google-chrome --no-sandbox'" >> /etc/bash.bashrc && \
    sed -i 's|^Exec=/usr/bin/google-chrome-stable .*|Exec=google-chrome --no-sandbox %U|' /usr/share/applications/google-chrome.desktop || true && \
    rm /usr/share/applications/xfce4-web-browser.desktop || true

COPY .docker/ros_entrypoint_novnc.sh /ros_entrypoint.sh
RUN chmod +x /ros_entrypoint.sh
ENTRYPOINT ["/ros_entrypoint.sh"]
CMD ["bash"]